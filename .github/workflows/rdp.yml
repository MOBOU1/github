name: Ephemeral Windows RDP

on:
  workflow_dispatch:

jobs:
  rdp:
    runs-on: windows-latest
    timeout-minutes: 360
    steps:
      - name: Set RDP password for runneradmin
        shell: powershell
        run: |
          $pwdPlain = "${{ secrets.RDP_PASSWORD }}"
          if ([string]::IsNullOrWhiteSpace($pwdPlain)) {
            throw "RDP_PASSWORD secret is missing."
          }
          $password = ConvertTo-SecureString $pwdPlain -AsPlainText -Force
          $user = "runneradmin"
          # ØªØ£Ù…ÙŠÙ† Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙˆØªÙ…ÙƒÙŠÙ†Ù‡
          Set-LocalUser -Name $user -Password $password
          net user $user /active:yes
          # Ø¶Ù…Ø§Ù† Ø§Ù„Ø³Ù…Ø§Ø­ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„Ù€ RDP
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member $user -ErrorAction SilentlyContinue
          Write-Host "Password set and RDP group membership ensured for $user."

      - name: Enable Remote Desktop + Firewall
        shell: powershell
        run: |
          # ØªÙØ¹ÙŠÙ„ RDP
          Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections" -Value 0
          # ØªÙ…ÙƒÙŠÙ† Ø¬Ø¯Ø§Ø± Ø§Ù„Ø­Ù…Ø§ÙŠØ© Ù„Ù‚ÙˆØ§Ø¹Ø¯ RDP
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          # ÙØ±Ø¶ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø´Ø¨ÙƒØ© (Ù…ÙˆØµÙ‰ Ø¨Ù‡)
          Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" -Name "UserAuthentication" -Value 1
          Write-Host "RDP enabled and firewall configured."

      - name: Download ngrok
        shell: powershell
        run: |
          $url = "https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-windows-amd64.zip"
          Invoke-WebRequest -Uri $url -OutFile "ngrok.zip"
          Expand-Archive ngrok.zip -DestinationPath .
          .\ngrok.exe version

      - name: Auth ngrok
        shell: powershell
        run: .\ngrok.exe config add-authtoken "${{ secrets.NGROK_AUTH_TOKEN }}"

      - name: Start ngrok TCP tunnel on 3389
        shell: powershell
        run: |
          # Ø´ØºÙ‘Ù„ ngrok Ø¨Ø§Ù„Ø®Ù„ÙÙŠØ©
          Start-Process -FilePath ".\ngrok.exe" -ArgumentList "tcp 3389 --region=eu" -NoNewWindow
          Start-Sleep -Seconds 6
          # Ø¬Ø±Ù‘Ø¨ ÙˆØ§Ø¬Ù‡Ø© ngrok Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¹Ø§Ù…
          $public = $null
          try {
            $tunnels = Invoke-RestMethod -Uri "http://127.0.0.1:4040/api/tunnels" -TimeoutSec 5
            $public = ($tunnels.tunnels | Where-Object {$_.proto -eq "tcp"}).public_url
          } catch {
            Write-Host "ngrok API not ready; attempting log parsing..."
          }
          if (-not $public) {
            # Ø®Ø· Ø±Ø¬Ø¹Ø©: Ø£Ø¹Ø¯ ØªØ´ØºÙŠÙ„ ngrok Ù…Ø¹ logfmt ÙˆØ§Ø·Ù„Ø¹ Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø¬Ù„ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
            $p = Start-Process -FilePath ".\ngrok.exe" -ArgumentList "tcp 3389 --region=eu --log=stdout --log-format=logfmt" -NoNewWindow -PassThru -RedirectStandardOutput "ngrok.log"
            Start-Sleep -Seconds 6
            $match = Select-String -Path "ngrok.log" -Pattern "url=tcp://[^\s]+" | Select-Object -Last 1
            if ($match) {
              $public = ($match.Matches[0].Value -split "url=")[1]
            }
          }
          if (-not $public) { throw "Failed to discover ngrok public TCP URL." }

          $addr = $public.Replace("tcp://","")
          "ğŸ”— **RDP Address:** $addr" | Out-File -FilePath "$env:GITHUB_STEP_SUMMARY" -Append
          "ğŸ‘¤ **Username:** runneradmin" | Out-File -FilePath "$env:GITHUB_STEP_SUMMARY" -Append
          "ğŸ”‘ **Password:** (the secret you set in RDP_PASSWORD)" | Out-File -FilePath "$env:GITHUB_STEP_SUMMARY" -Append
          Write-Host "Ngrok public URL: $public"

      - name: Keep session alive (up to 6h)
        shell: powershell
        run: |
          for ($i=1; $i -le 360; $i++) {
            Write-Host "RDP live... minute $i / 360"
            Start-Sleep -Seconds 60
          }
